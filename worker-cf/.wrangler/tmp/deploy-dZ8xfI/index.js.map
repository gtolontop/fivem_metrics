{
  "version": 3,
  "sources": ["../../../index.ts"],
  "sourceRoot": "C:\\Users\\teamr\\Desktop\\ReactProject\\fivem_metrics\\worker-cf\\.wrangler\\tmp\\deploy-dZ8xfI",
  "sourcesContent": ["/**\n * Cloudflare Worker - FREE tier: 100k requests/day\n */\n\ninterface Env {\n  API_BASE: string\n}\n\ninterface WorkerTask {\n  type: 'ip_fetch' | 'scan'\n  serverId: string\n  ip?: string\n}\n\ninterface IpResult {\n  serverId: string\n  ip: string | null\n  error?: string\n}\n\ninterface ScanResult {\n  serverId: string\n  ip: string\n  online: boolean\n  resources?: string[]\n  players?: number\n  error?: string\n}\n\nasync function fetchIp(serverId: string): Promise<IpResult> {\n  try {\n    const res = await fetch(`https://servers-frontend.fivem.net/api/servers/single/${serverId}`, {\n      headers: { 'User-Agent': 'Mozilla/5.0' }\n    })\n    if (res.status === 429) return { serverId, ip: null, error: 'rate_limited' }\n    if (!res.ok) return { serverId, ip: null, error: `http_${res.status}` }\n    const data = await res.json() as { Data?: { connectEndPoints?: string[] } }\n    return { serverId, ip: data.Data?.connectEndPoints?.[0] || null }\n  } catch (e) {\n    return { serverId, ip: null, error: String(e) }\n  }\n}\n\nasync function scanServer(serverId: string, ip: string): Promise<ScanResult> {\n  try {\n    const controller = new AbortController()\n    const timeout = setTimeout(() => controller.abort(), 5000)\n    const res = await fetch(`http://${ip}/info.json`, {\n      signal: controller.signal,\n      headers: { 'User-Agent': 'Mozilla/5.0' }\n    })\n    clearTimeout(timeout)\n    if (!res.ok) return { serverId, ip, online: false, error: `http_${res.status}` }\n    const data = await res.json() as { resources?: string[], vars?: { sv_maxClients?: string } }\n    return {\n      serverId, ip, online: true,\n      resources: data.resources || [],\n      players: data.vars?.sv_maxClients ? parseInt(data.vars.sv_maxClients) : 0\n    }\n  } catch (e) {\n    return { serverId, ip, online: false, error: String(e) }\n  }\n}\n\n// Execute one batch of work\nasync function doWork(env: Env, preferType: string): Promise<{\n  tasks: number\n  ipSuccess: number\n  ipFailed: number\n  scanOnline: number\n  scanOffline: number\n  error?: string\n}> {\n  try {\n    const workRes = await fetch(`${env.API_BASE}/api/queue/work?worker=cloudflare&type=${preferType}`)\n    if (!workRes.ok) {\n      return { tasks: 0, ipSuccess: 0, ipFailed: 0, scanOnline: 0, scanOffline: 0, error: `http_${workRes.status}` }\n    }\n    const workData = await workRes.json() as { tasks: WorkerTask[], count: number }\n\n    if (!workData.tasks?.length) {\n      return { tasks: 0, ipSuccess: 0, ipFailed: 0, scanOnline: 0, scanOffline: 0 }\n    }\n\n    const ipTasks = workData.tasks.filter(t => t.type === 'ip_fetch')\n    const scanTasks = workData.tasks.filter(t => t.type === 'scan')\n\n    let ipSuccess = 0, ipFailed = 0, scanOnline = 0, scanOffline = 0\n\n    // Execute IP fetches\n    if (ipTasks.length > 0) {\n      const ipResults = await Promise.all(ipTasks.map(t => fetchIp(t.serverId)))\n      ipSuccess = ipResults.filter(r => r.ip !== null).length\n      ipFailed = ipResults.length - ipSuccess\n\n      await fetch(`${env.API_BASE}/api/queue/submit`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ type: 'ip_results', results: ipResults, workerId: 'cloudflare' })\n      })\n    }\n\n    // Execute scans\n    if (scanTasks.length > 0) {\n      const scanResults = await Promise.all(\n        scanTasks.filter(t => t.ip).map(t => scanServer(t.serverId, t.ip!))\n      )\n      scanOnline = scanResults.filter(r => r.online).length\n      scanOffline = scanResults.length - scanOnline\n\n      await fetch(`${env.API_BASE}/api/queue/submit`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ type: 'scan_results', results: scanResults, workerId: 'cloudflare' })\n      })\n    }\n\n    return { tasks: workData.count, ipSuccess, ipFailed, scanOnline, scanOffline }\n  } catch (e) {\n    return { tasks: 0, ipSuccess: 0, ipFailed: 0, scanOnline: 0, scanOffline: 0, error: String(e) }\n  }\n}\n\nexport default {\n  async fetch(request: Request, env: Env): Promise<Response> {\n    const url = new URL(request.url)\n\n    if (url.pathname === '/health') {\n      return new Response('OK')\n    }\n\n    // Single batch\n    if (url.pathname === '/work') {\n      const preferType = url.searchParams.get('type') || 'ip_fetch'\n      const startTime = Date.now()\n      const result = await doWork(env, preferType)\n      return Response.json({ ...result, timeMs: Date.now() - startTime })\n    }\n\n    // Multiple batches sequentially (not parallel to avoid subrequest limit)\n    if (url.pathname === '/rapid') {\n      const rounds = Math.min(parseInt(url.searchParams.get('rounds') || '3'), 5)\n      const preferType = url.searchParams.get('type') || 'ip_fetch'\n      const startTime = Date.now()\n\n      const totals = { tasks: 0, ipSuccess: 0, ipFailed: 0, scanOnline: 0, scanOffline: 0 }\n      const details: object[] = []\n\n      // Sequential to avoid too many subrequests\n      for (let i = 0; i < rounds; i++) {\n        const result = await doWork(env, preferType)\n        details.push({ round: i, ...result })\n        totals.tasks += result.tasks\n        totals.ipSuccess += result.ipSuccess\n        totals.ipFailed += result.ipFailed\n        totals.scanOnline += result.scanOnline\n        totals.scanOffline += result.scanOffline\n      }\n\n      return Response.json({\n        mode: 'rapid',\n        rounds,\n        totals,\n        details,\n        timeMs: Date.now() - startTime\n      })\n    }\n\n    return Response.json({\n      name: 'FiveM Metrics Worker',\n      endpoints: ['/work', '/rapid?rounds=3', '/health'],\n      apiBase: env.API_BASE\n    })\n  },\n\n  // Cron: run every minute\n  async scheduled(event: ScheduledEvent, env: Env, ctx: ExecutionContext) {\n    ctx.waitUntil(doWork(env, 'ip_fetch'))\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
